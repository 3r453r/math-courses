generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

// ── Auth.js models ──────────────────────────────────────────────

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  encryptedApiKeys String?
  role            String    @default("user")
  accessStatus    String    @default("pending")
  accessGrantedAt DateTime?
  accessSource    String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts            Account[]
  sessions            Session[]
  courses             Course[]
  accessCodeRedemptions AccessCodeRedemption[]
  courseRatings        CourseRating[]
  payments            Payment[]
  createdAccessCodes  AccessCode[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ── Application models ──────────────────────────────────────────

model Course {
  id                String   @id @default(cuid())
  userId            String
  title             String
  description       String
  topic             String
  subject           String   @default("[\"Other\"]")
  focusAreas        String   @default("[]")
  targetLessonCount Int      @default(10)
  difficulty        String   @default("intermediate")
  language          String   @default("en")
  contextDoc             String?
  passThreshold          Float    @default(0.8)
  noLessonCanFail        Boolean  @default(true)
  lessonFailureThreshold Float    @default(0.5)
  status                 String   @default("draft")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  clonedFromId      String?

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lessons           Lesson[]
  edges             CourseEdge[]
  notes             Note[]
  diagnosticQuiz    DiagnosticQuiz?
  completionSummary CourseCompletionSummary?
  shares            CourseShare[]

  @@index([userId])
}

model Lesson {
  id               String   @id @default(cuid())
  courseId          String
  title            String
  summary          String
  orderIndex       Int
  status           String   @default("pending")
  contentJson      String?
  rawMarkdown      String?
  generationPrompt String?
  isSupplementary  Boolean  @default(false)
  weight           Float    @default(1.0)
  completedAt      DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  course          Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  quizzes         Quiz[]
  notes           Note[]
  chatMessages    ChatMessage[]
  prerequisiteFor CourseEdge[]  @relation("FromLesson")
  dependsOn       CourseEdge[]  @relation("ToLesson")

  @@index([courseId])
}

model CourseEdge {
  id           String @id @default(cuid())
  courseId      String
  fromLessonId String
  toLessonId   String
  relationship String @default("prerequisite")

  course     Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  fromLesson Lesson @relation("FromLesson", fields: [fromLessonId], references: [id], onDelete: Cascade)
  toLesson   Lesson @relation("ToLesson", fields: [toLessonId], references: [id], onDelete: Cascade)

  @@unique([fromLessonId, toLessonId])
  @@index([courseId])
}

model DiagnosticQuiz {
  id            String   @id @default(cuid())
  courseId      String   @unique
  questionsJson String
  status        String   @default("pending")
  createdAt     DateTime @default(now())

  course   Course              @relation(fields: [courseId], references: [id], onDelete: Cascade)
  attempts DiagnosticAttempt[]
}

model DiagnosticAttempt {
  id                   String   @id @default(cuid())
  diagnosticQuizId     String
  answersJson          String
  score                Float
  weakAreas            String
  recommendation       String
  suggestedCourseTitle String?
  createdAt            DateTime @default(now())

  diagnosticQuiz DiagnosticQuiz @relation(fields: [diagnosticQuizId], references: [id], onDelete: Cascade)

  @@index([diagnosticQuizId])
}

model Quiz {
  id            String   @id @default(cuid())
  lessonId      String
  questionsJson String
  questionCount Int      @default(15)
  status        String   @default("pending")
  generation    Int      @default(1)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())

  lesson   Lesson        @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  attempts QuizAttempt[]

  @@index([lessonId])
}

model QuizAttempt {
  id             String   @id @default(cuid())
  quizId         String
  answersJson    String
  score          Float
  weakTopics     String
  recommendation String
  createdAt      DateTime @default(now())

  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([quizId])
}

model Note {
  id           String   @id @default(cuid())
  lessonId     String?
  courseId      String?
  title        String?
  content      String
  isScratchpad Boolean  @default(false)
  orderIndex   Float    @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  lesson Lesson? @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  course Course? @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([lessonId])
  @@index([courseId])
}

model ChatMessage {
  id        String   @id @default(cuid())
  lessonId  String
  role      String
  content   String
  createdAt DateTime @default(now())

  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId])
}

model CourseCompletionSummary {
  id                 String   @id @default(cuid())
  courseId            String   @unique
  summaryJson        String
  narrativeMarkdown  String?
  recommendationJson String?
  completedAt        DateTime @default(now())

  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
}

model CourseShare {
  id         String    @id @default(cuid())
  courseId    String
  shareToken String    @unique
  isActive   Boolean   @default(true)
  expiresAt  DateTime?
  createdAt  DateTime  @default(now())

  // Gallery fields
  isGalleryListed    Boolean   @default(false)
  galleryTitle       String?
  galleryDescription String?
  tags               String    @default("[]")
  starCount          Int       @default(0)
  cloneCount         Int       @default(0)
  featuredAt         DateTime?

  course  Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  ratings CourseRating[]

  @@index([courseId])
}

// ── Access & Payment models ──────────────────────────────────────

model AccessCode {
  id         String    @id @default(cuid())
  code       String    @unique
  type       String    @default("general")
  maxUses    Int       @default(1)
  currentUses Int      @default(0)
  isActive   Boolean   @default(true)
  expiresAt  DateTime?
  createdBy  String?
  createdAt  DateTime  @default(now())

  creator     User?                 @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  redemptions AccessCodeRedemption[]
}

model AccessCodeRedemption {
  id           String   @id @default(cuid())
  accessCodeId String
  userId       String
  redeemedAt   DateTime @default(now())

  accessCode AccessCode @relation(fields: [accessCodeId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([accessCodeId, userId])
}

model CourseRating {
  id            String   @id @default(cuid())
  courseShareId  String
  userId        String
  rating        Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  courseShare CourseShare @relation(fields: [courseShareId], references: [id], onDelete: Cascade)
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([courseShareId, userId])
}

model Payment {
  id              String   @id @default(cuid())
  userId          String
  stripeSessionId String   @unique
  amount          Int
  currency        String
  status          String
  accessCodeId    String?
  createdAt       DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ── AI Generation Logging ──────────────────────────────────────

model AiGenerationLog {
  id             String   @id @default(cuid())

  // What was being generated
  generationType String   // "course"|"lesson"|"quiz"|"diagnostic"|"trivia"|"completion_summary"
  schemaName     String   // "courseStructureSchema"|"lessonContentSchema"|etc.
  modelId        String   // "claude-opus-4-6", "gpt-5.2", etc.
  provider       String   // "anthropic"|"openai"|"google"

  // Domain entity references (no FK — logs survive entity deletion)
  userId         String?
  courseId        String?
  lessonId       String?

  // Final outcome
  outcome        String   // "success"|"repaired_layer0"|"repaired_layer1"|"repaired_layer2"|"failed"
  durationMs     Int

  // Layer 0 (experimental_repairText)
  layer0Called    Boolean  @default(false)
  layer0Result   String?  // "coercion-success"|"unwrapped-only"|"json-parse-failed"|"returned-null"
  layer0Error    String?

  // Layer 1 (catch-block direct coercion)
  layer1Called    Boolean  @default(false)
  layer1Success  Boolean  @default(false)
  layer1HadWrapper Boolean @default(false)

  // Layer 2 (AI repack)
  layer2Called    Boolean  @default(false)
  layer2Success  Boolean  @default(false)
  layer2ModelId  String?

  // Raw AI output for replication
  rawOutputText  String?  // up to 200KB, truncated with marker
  rawOutputLen   Int?     // always stored even if text is truncated

  // Validation details
  zodErrors      String?  // JSON array of {path, code, message}
  errorMessage   String?  // final error if outcome="failed"

  // Prompt fingerprint for grouping
  promptHash     String?  // SHA-256 hex
  promptText     String?  // stored only on non-success outcomes

  // Request metadata
  language       String?
  difficulty     String?

  createdAt      DateTime @default(now())

  @@index([generationType])
  @@index([outcome])
  @@index([modelId])
  @@index([createdAt])
  @@index([courseId])
}
